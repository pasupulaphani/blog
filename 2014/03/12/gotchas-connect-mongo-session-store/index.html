<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Phaninder,hello@phaninder.com"><title>Gotchas, Connect-mongo session store · Phani</title><meta name="description" content="connect-mongo module which is commonly used for session store for a MongoDb backend. This post is an extension for my previous post MongoDB/Mongoose c"><meta name="keywords" content="Scaling Infrastructure, Docker, NodeJs, Postgres, ReactJs, Phonegap, Web application security, es7"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/ds-embed.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Phani</a></h3><div class="description"><p>My findings and ramblings</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/PhaniPasupula" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="https://uk.linkedin.com/in/phaninder-pasupula-aab4a02b" target="_blank"><i class="fa fa-linkedin"></i></a></li></ul><div class="footer"><div class="by_farbox"><a href="" target="_blank">Copyright 2014-2017</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/archives">Archive</a></li><li><a href="/links">Links</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="https://secure.gravatar.com/avatar/da8ad3d7a783fda9082894427e6be2a9?s=180&amp;r=G&amp;d="></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Gotchas, Connect-mongo session store</a></h3></div><div class="post-content"><p><a href="https://github.com/kcbanner/connect-mongo" target="_blank" rel="external">connect-mongo</a> module which is commonly used for session store for a MongoDb backend. This post is an extension for my previous post <a href="mongodb-error-trying-to-open-unclosed-connection/edit">MongoDB/Mongoose connect best practices</a>. In this post I would like to elaborate good practices in using session store.</p>
<p><strong>Initialization</strong></p>
<p>When using mongoose with connect-mongo you need to initialize the session store after mongoose connects.</p>
<p><code>[https://gist.github.com/pasupulaphani/9463004?file=mongostore_conn.js](https://gist.github.com/pasupulaphani/9463004?file=mongostore_conn.js)</code></p>
<p>If not this might lead to the below errors.</p>
<blockquote>
<p>Error:Trying to open unclosed connection.</p>
<p>Error: Error setting TTL index on collection : sessions</p>
</blockquote>
<p><strong>Enable auto reconnect</strong></p>
<p>It also takes the param <code>&lt;span class=&quot;s2&quot;&gt;&quot;auto_reconnect&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;</code>. This will be passed as constructor to MongoDb server as the auto_reconnect option. By setting this you can avoid the below error</p>
<blockquote>
<p>Error: no open connections</p>
</blockquote>
<p>Sample set-up can be found <a href="https://gist.github.com/pasupulaphani/9463004#file-connect-mongo_session_store-js" target="_blank" rel="external">here</a>.</p>
<p><code>[https://gist.github.com/pasupulaphani/9463004?file=connect-mongo_session_store.js](https://gist.github.com/pasupulaphani/9463004?file=connect-mongo_session_store.js)</code></p>
<p><strong>Use existing Mongoose or Mongo native connection</strong></p>
<p>Yes, instead of creating a new Db object, you can just reuse the <strong>db object</strong> or <strong>a connection</strong> already instantiated by mongoose!</p>
<p><code>[https://gist.github.com/pasupulaphani/9463004?file=connect-mongo_use_mongoose_conn1.js](https://gist.github.com/pasupulaphani/9463004?file=connect-mongo_use_mongoose_conn1.js)</code></p>
<p><code>[https://gist.github.com/pasupulaphani/9463004?file=connect-mongo_use_mongoose_conn2.js](https://gist.github.com/pasupulaphani/9463004?file=connect-mongo_use_mongoose_conn2.js)</code></p>
<p>Also make sure that <code>&lt;span class=&quot;nx&quot;&gt;mongoose&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;connection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;</code><span class="nx"><code>db</code> is fully initialized before used for session store otherwise it fails with TTL for ‘sessions’ error.</span></p>
<p><strong>Using connect events</strong></p>
<p>It is common practice to start app initialization with connection open event. If you use ‘open’ or ‘connecting’ events, there is a good possibility that the connection might not be fully initialized by the time you use it for session store. Make sure that you use appropriate events like ‘connected’ before you use existing mongoose connection. If not you might encounter above errors. Below is from a sample from my <a href="mongodb-error-trying-to-open-unclosed-connection/edit">other post</a></p>
<p><code>[https://gist.github.com/pasupulaphani/9463004?file=mongoose_connet.js](https://gist.github.com/pasupulaphani/9463004?file=mongoose_connet.js)</code></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2014-03-12</span><i class="fa fa-tag"></i></div></div></div></div><div class="share"><div class="evernote"> <a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"> <a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"> <a href="http://twitter.com/home?status=,http://phaninder.com/2014/03/12/gotchas-connect-mongo-session-store/,Phani,Gotchas, Connect-mongo session store,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2015/01/24/restful-put-misconceptions/" title="RESTful - put misconceptions" class="btn">prev_post</a></li><li class="next pagbuttons"><a role="navigation" href="/2014/03/10/mongodbmongoose-connect-best-practices/" title="MongoDB/Mongoose connect best practices" class="btn">next_post</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>