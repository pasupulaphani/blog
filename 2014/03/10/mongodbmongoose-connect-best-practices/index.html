<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Phaninder,hello@phaninder.com"><title>MongoDB/Mongoose connect best practices · Phani</title><meta name="description" content="It is important how to handle your MongoDb connections in your app. Basically when you fail to close an connection and try to open it instantaneously,"><meta name="keywords" content="Scaling Infrastructure, Docker, NodeJs, Postgres, ReactJs, Phonegap, Web application security, es7"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/ds-embed.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Phani</a></h3><div class="description"><p>My findings and ramblings</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/PhaniPasupula" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="https://uk.linkedin.com/in/phaninder-pasupula-aab4a02b" target="_blank"><i class="fa fa-linkedin"></i></a></li></ul><div class="footer"><div class="by_farbox"><a href="" target="_blank">Copyright 2014-2017</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/archives">Archive</a></li><li><a href="/links">Links</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="https://secure.gravatar.com/avatar/da8ad3d7a783fda9082894427e6be2a9?s=180&amp;r=G&amp;d="></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>MongoDB/Mongoose connect best practices</a></h3></div><div class="post-content"><p>It is important how to handle your MongoDb connections in your app. Basically when you fail to close an connection and try to open it instantaneously, you probably encounter this error. It can be while retrieving data, running tests, creating sessions.</p>
<blockquote>
<p>Error:Trying to open unclosed connection.</p>
</blockquote>
<p>As the error says you are trying to open an unclosed connection with MongoDb. Few things to know before you start with Mongoose to avoid these type of errors:</p>
<ul>
<li>Do not open a connection for each web request.</li>
<li>Open it and leave it open until you close/shutdown your app.</li>
<li>Use createConnection instead of mongoose.connect if needed to connect to several different databases</li>
</ul>
<h4 id="Mongoose-connect-sample"><a href="#Mongoose-connect-sample" class="headerlink" title="Mongoose connect sample"></a>Mongoose connect sample</h4><p><code>[https://gist.github.com/pasupulaphani/9463004?file=mongoose_connet.js](https://gist.github.com/pasupulaphani/9463004?file=mongoose_connet.js)</code></p>
<ul>
<li>Use <a href="http://mongoosejs.com/docs/api.html#index_Mongoose-createConnection" target="_blank" rel="external">mongoose.createConnection</a> to create a new connection instance if needed.</li>
<li>For long running applications if you see <code>&quot;connection closed&quot;</code> errors try enable <code>keepAlive</code></li>
</ul>
<p><code>mongoose.connect</code> opens a pool of connections that concurrent requests can share. You shouldn’t be connecting and disconnecting on each request. Instead, connect during your application start up and disconnect during shutdown.</p>
<h4 id="Mongoose-response-hooks"><a href="#Mongoose-response-hooks" class="headerlink" title="Mongoose response hooks"></a>Mongoose response hooks</h4><p>Sometimes when you are streaming huge data you may need to close connections after every request. For this you can use after response events/hooks.</p>
<p><code>[https://gist.github.com/pasupulaphani/9463004?file=after_res_hooks.js](https://gist.github.com/pasupulaphani/9463004?file=after_res_hooks.js)</code></p>
<h4 id="Connect-mongo-session-store-tips"><a href="#Connect-mongo-session-store-tips" class="headerlink" title="Connect-mongo session store tips"></a>Connect-mongo session store tips</h4><p><a href="https://github.com/kcbanner/connect-mongo" target="_blank" rel="external">connect-mongo</a> module which is commonly used for session store takes the param <code>&lt;span class=&quot;s2&quot;&gt;&quot;auto_reconnect&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;</code>. This will be passed as constructor to MongoDb server as the auto_reconnect option.</p>
<p><em>When using mongoose with connect-mongo you need to initialize the session store after mongoose connects.</em></p>
<p>Sample set-up can be found <a href="https://gist.github.com/pasupulaphani/9463004#file-connect-mongo_session_store-js" target="_blank" rel="external">here</a>.</p>
<p><strong><span class="js-issue-title">Use existing mongoose connection</span></strong></p>
<p>Yes, instead of creating a new Db object, you can just reuse the db object already instantiated by mongoose!</p>
<p><code>[https://gist.github.com/pasupulaphani/9463004?file=connect-mongo_use_mongoose_conn1.js](https://gist.github.com/pasupulaphani/9463004?file=connect-mongo_use_mongoose_conn1.js)</code></p>
<p><code>[https://gist.github.com/pasupulaphani/9463004?file=connect-mongo_use_mongoose_conn2.js](https://gist.github.com/pasupulaphani/9463004?file=connect-mongo_use_mongoose_conn2.js)</code></p>
<h4 id="Mocha-Tests"><a href="#Mocha-Tests" class="headerlink" title="Mocha Tests"></a>Mocha Tests</h4><p>You don’t have to open a new connection for each test, connect once at the top level of your test and re-use the connection</p>
<p><code>[https://gist.github.com/pasupulaphani/9463004?file=mocha_tests.js](https://gist.github.com/pasupulaphani/9463004?file=mocha_tests.js)</code></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2014-03-10</span><i class="fa fa-tag"></i></div></div></div></div><div class="share"><div class="evernote"> <a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"> <a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"> <a href="http://twitter.com/home?status=,http://phaninder.com/2014/03/10/mongodbmongoose-connect-best-practices/,Phani,MongoDB/Mongoose connect best practices,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2014/03/12/gotchas-connect-mongo-session-store/" title="Gotchas, Connect-mongo session store" class="btn">prev_post</a></li><li class="next pagbuttons"><a role="navigation" href="/2014/02/21/reactor-pattern-general-architecture-for-event-driven-systems/" title="Reactor pattern: general architecture for event-driven systems" class="btn">next_post</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>